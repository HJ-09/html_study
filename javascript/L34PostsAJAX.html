<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>S20 과제 - 비동기로 게시글 불러오기</title>
</head>
<body>
    <h1>S20 과제 - 비동기로 게시글 불러오기</h1>
    <p>
        <button id="loadPostsBtn">불러오기</button>
    </p>
    <hr>
    <style>
        .d-none{
            display: none;
        }
    </style>
    <li id="postEx" class="post d-none">
        <h4>
            <b class="id"></b><b>.</b>
            <span class="title"></span>
            (<span class="userId"></span>)
        </h4>
        <hr>
        <pre class="body"></pre>
        <hr>
        <div>
            <p>
                <button class="loadCommentBtn">댓글불러오기</button>
            </p>
            <ul class="comments"></ul>
        </div>

    </li>
    <ul id="posts"></ul>


    <script>
        const postsUl=document.querySelector('#posts');
        const loadPostsBtn=document.getElementById('loadPostsBtn');

        const postEx=document.getElementById('postEx');


        const commentNode=(comment)=>{
            const li=document.createElement('li');
            let text=`${comment.id} / ${comment.name} / ${comment.email} / `;
            const hr=document.createElement('hr');
            let body=comment.body;
            li.append(text);
            li.append(body);
            li.append(hr);
            return li;
        }

        const clonePostNode=(post)=>{
            const postNode=postEx.cloneNode(true);
            postNode.removeAttribute('id');
            postNode.classList.remove('d-none');

            let id=postNode.querySelector('.id');
            let title=postNode.querySelector('.title');
            let userId=postNode.querySelector('.userId');
            let body=postNode.querySelector('.body');
            let loadCommentBtn=postNode.querySelector('.loadCommentBtn');
            let comments=postNode.querySelector('.comments');

            id.append(post.id);
            title.append(post.title);
            userId.append(post.userId);
            body.append(post.body);

            //loadCommentBtn.addEventListener('click', loadComments()) ⇒ x. 완전히 잘못된 코드
            //loadCommentBtn.addEventListener('click', loadComments) ⇒ x. postId가 매개변수로 있어서 안됨.

            loadCommentBtn.addEventListener('click', (e)=>{
                loadComments(e, post.id, comments);
            })
            return postNode;
        }

        const loadComments=(e,postId, commentsUl)=>{
            //const commentsUl=document.querySelector('#comments-'+postId);
            let url=`https://jsonplaceholder.typicode.com/posts/${postId}/comments`;
            const req=new XMLHttpRequest();
            req.open('get',url,true);
            req.send();
            req.onload=()=>{
                if (req.status===200){
                    const comments=JSON.parse(req.responseText);
                    let html="";
                    /*for (let comment of comments){
                        const li=commentNode(comment);
                        commentsUl.append(li);
                    }*/

                    const cloneCommentsArr=comments.map((comment)=>{
                        return commentNode(comment);
                    })
                    // cloneCommentsArr.forEach((comment)=>{
                    //     commentsUl.append(comment);
                    // })
                    commentsUl.append(...cloneCommentsArr);
                    //...는 매개변수로 arguments(...args)를 지원하는 함수만 가능
                }
            }
        }

        const loadPosts=()=>{
            let url="https://jsonplaceholder.typicode.com/posts";
            const req=new XMLHttpRequest() //readystate===1
            req.open("GET",url,true); //2
            req.send(); //통신
            req.onload=()=>{ //onload를 쓸 때는 무조건 status 코드를 확인해야함..!
                let status=req.status;
                if (status===200){
                    let postsJson=req.responseText;
                    let posts=JSON.parse(postsJson);
                    //console.log(posts);
                    //let html="";
                    /*for (let post of posts){
                        const postNode=clonePostNode(post);
                        console.log(postNode);
                        postsUl.append(postNode);

                    }*/

                    const clonePostArr=posts.map((post)=>{
                        return clonePostNode(post);
                    })
                    /*console.log(posts);
                    console.log(clonePostArr);*/
                    postsUl.append(...clonePostArr)
                }

            }
        }
        //loadPosts(); //비동기는 바로 보여지는거 아니고 보통 버튼 많이 씀
        loadPostsBtn.addEventListener('click',loadPosts);

    </script>
</body>
</html>